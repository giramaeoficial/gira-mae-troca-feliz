<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug OneSignal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Debug OneSignal - GiraM√£e</h1>
    
    <div class="debug-box">
        <h2>1. Status do OneSignal</h2>
        <div id="oneSignalStatus" class="status info">Verificando...</div>
        <button onclick="checkOneSignal()">Verificar OneSignal</button>
    </div>

    <div class="debug-box">
        <h2>2. Permiss√µes do Navegador</h2>
        <div id="permissionStatus" class="status info">Verificando...</div>
        <button onclick="checkPermissions()">Verificar Permiss√µes</button>
    </div>

    <div class="debug-box">
        <h2>3. Player ID</h2>
        <div id="playerIdStatus" class="status info">Verificando...</div>
        <button onclick="getPlayerId()">Obter Player ID</button>
    </div>

    <div class="debug-box">
        <h2>4. Inicializar OneSignal</h2>
        <div id="initStatus" class="status info">Pronto para inicializar</div>
        <button onclick="initializeOneSignal()">Inicializar OneSignal</button>
    </div>

    <div class="debug-box">
        <h2>5. Log de Debug</h2>
        <pre id="debugLog"></pre>
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <script>
        let debugLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            document.getElementById('debugLog').textContent = debugLog.join('\n');
            console.log(logMessage);
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = '';
        }

        function checkOneSignal() {
            log('üîç Verificando OneSignal...');
            
            if (typeof window.OneSignal === 'undefined') {
                document.getElementById('oneSignalStatus').innerHTML = '‚ùå OneSignal n√£o carregado';
                document.getElementById('oneSignalStatus').className = 'status error';
                log('‚ùå OneSignal n√£o encontrado no window');
                return;
            }

            if (window.OneSignal.initialized) {
                document.getElementById('oneSignalStatus').innerHTML = '‚úÖ OneSignal carregado e inicializado';
                document.getElementById('oneSignalStatus').className = 'status success';
                log('‚úÖ OneSignal inicializado');
            } else {
                document.getElementById('oneSignalStatus').innerHTML = '‚ö†Ô∏è OneSignal carregado mas n√£o inicializado';
                document.getElementById('oneSignalStatus').className = 'status warning';
                log('‚ö†Ô∏è OneSignal n√£o inicializado');
            }
        }

        function checkPermissions() {
            log('üîç Verificando permiss√µes...');
            
            if (!('Notification' in window)) {
                document.getElementById('permissionStatus').innerHTML = '‚ùå Navegador n√£o suporta notifica√ß√µes';
                document.getElementById('permissionStatus').className = 'status error';
                log('‚ùå Notification API n√£o suportada');
                return;
            }

            const permission = Notification.permission;
            log(`üìã Permiss√£o atual: ${permission}`);
            
            if (permission === 'granted') {
                document.getElementById('permissionStatus').innerHTML = '‚úÖ Permiss√£o concedida';
                document.getElementById('permissionStatus').className = 'status success';
            } else if (permission === 'denied') {
                document.getElementById('permissionStatus').innerHTML = '‚ùå Permiss√£o negada';
                document.getElementById('permissionStatus').className = 'status error';
            } else {
                document.getElementById('permissionStatus').innerHTML = '‚ö†Ô∏è Permiss√£o pendente';
                document.getElementById('permissionStatus').className = 'status warning';
            }
        }

        async function getPlayerId() {
            log('üîç Obtendo Player ID...');
            
            try {
                if (window.OneSignal && window.OneSignal.User && window.OneSignal.User.PushSubscription) {
                    const playerId = window.OneSignal.User.PushSubscription.id;
                    const optedIn = window.OneSignal.User.PushSubscription.optedIn;
                    
                    if (playerId) {
                        document.getElementById('playerIdStatus').innerHTML = `‚úÖ Player ID: ${playerId}<br>Inscrito: ${optedIn}`;
                        document.getElementById('playerIdStatus').className = 'status success';
                        log(`‚úÖ Player ID obtido: ${playerId}`);
                        log(`üìã Opted In: ${optedIn}`);
                    } else {
                        document.getElementById('playerIdStatus').innerHTML = '‚ùå Player ID n√£o encontrado';
                        document.getElementById('playerIdStatus').className = 'status error';
                        log('‚ùå Player ID n√£o encontrado');
                    }
                } else {
                    document.getElementById('playerIdStatus').innerHTML = '‚ùå OneSignal.User n√£o dispon√≠vel';
                    document.getElementById('playerIdStatus').className = 'status error';
                    log('‚ùå OneSignal.User n√£o dispon√≠vel');
                }
            } catch (error) {
                document.getElementById('playerIdStatus').innerHTML = `‚ùå Erro: ${error.message}`;
                document.getElementById('playerIdStatus').className = 'status error';
                log(`‚ùå Erro ao obter Player ID: ${error.message}`);
            }
        }

        async function initializeOneSignal() {
            log('üöÄ Inicializando OneSignal...');
            
            try {
                if (typeof window.OneSignal === 'undefined') {
                    log('‚ùå OneSignal n√£o carregado, carregando script...');
                    await loadOneSignalScript();
                }

                window.OneSignal = window.OneSignal || [];
                
                const config = {
                    appId: "26d188ec-fdd6-41b3-86fe-b571cce6b3a5",
                    safari_web_id: "web.onesignal.auto.18b8e93e-b4c1-4e53-b3f4-0e481e0d79d4",
                    notifyButton: {
                        enable: true,
                    },
                    allowLocalhostAsSecureOrigin: true,
                };

                log('üîß Configurando OneSignal...');
                log(`üìã Config: ${JSON.stringify(config, null, 2)}`);

                await window.OneSignal.init(config);
                
                document.getElementById('initStatus').innerHTML = '‚úÖ OneSignal inicializado com sucesso';
                document.getElementById('initStatus').className = 'status success';
                log('‚úÖ OneSignal inicializado com sucesso');
                
                // Verificar novamente ap√≥s inicializa√ß√£o
                setTimeout(() => {
                    checkOneSignal();
                    getPlayerId();
                }, 2000);
                
            } catch (error) {
                document.getElementById('initStatus').innerHTML = `‚ùå Erro na inicializa√ß√£o: ${error.message}`;
                document.getElementById('initStatus').className = 'status error';
                log(`‚ùå Erro na inicializa√ß√£o: ${error.message}`);
            }
        }

        function loadOneSignalScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js';
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Verifica√ß√µes autom√°ticas ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkOneSignal();
                checkPermissions();
            }, 1000);
        });
    </script>
</body>
</html>